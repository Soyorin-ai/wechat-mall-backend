# 技术栈选择说明

本文档详细说明项目中使用的技术栈及其选择原因。

---

## 📦 核心框架

### NestJS v10+

**选择原因：**
1. **渐进式框架** - 可以从小型项目逐步扩展到大型微服务架构
2. **TypeScript 原生支持** - 类型安全，开发体验好
3. **模块化架构** - 代码组织清晰，易于维护和扩展
4. **依赖注入 (DI)** - 降低模块间耦合度
5. **装饰器语法** - 代码简洁，可读性强
6. **丰富的生态** - 大量第三方模块，开发效率高
7. **内置支持** - 验证、异常处理、日志等开箱即用

**不选择 Express/Koa 的原因：**
- Express 需要自己搭建架构，缺少规范
- Koa 虽然轻量，但缺少内置功能
- NestJS 提供了企业级应用需要的完整功能

---

## 💾 数据库层

### PostgreSQL 14+

**选择原因：**
1. **开源免费** - 无许可证成本
2. **ACID 事务支持** - 保证数据一致性（订单、支付场景至关重要）
3. **JSONB 支持** - 灵活的 JSON 数据存储（商品规格、订单详情）
4. **性能优秀** - 复杂查询性能优异
5. **成熟稳定** - 企业级应用广泛使用
6. **丰富的索引** - B-tree、Gin、Gist 等多种索引类型
7. **扩展性强** - PostGIS 等扩展支持

**使用场景：**
- 用户数据、订单数据、商品数据等核心业务数据
- 需要事务支持的场景
- 关联查询较多的场景

**不选择 MySQL 的原因：**
- PostgreSQL 的 JSON 支持更好
- 复杂查询性能更优
- 更好的并发处理能力

### MongoDB 6+

**选择原因：**
1. **Schema 灵活** - 适合存储非结构化数据
2. **高性能写入** - 日志、评论等场景写入性能好
3. **横向扩展** - 易于分片扩展
4. **文档模型** - 与前端 JSON 格式天然契合
5. **聚合框架** - 强大的数据处理能力

**使用场景：**
- 商品详情（富文本、图片等）
- 商品评论
- 用户浏览历史、收藏记录
- 系统日志

**不选择 CouchDB 的原因：**
- MongoDB 生态更成熟
- 中文资料更多
- 社区支持更好

### Redis 7+

**选择原因：**
1. **极高性能** - 内存存储，响应速度快
2. **丰富的数据结构** - String、Hash、List、Set、ZSet
3. **原子操作** - 支持分布式锁、计数器等
4. **消息队列** - Pub/Sub 支持（配合 BullMQ）
5. **过期策略** - 自动过期，方便实现缓存 TTL
6. **集群支持** - 易于扩展

**使用场景：**
- 缓存（用户信息、商品信息、配置信息）
- Session 存储
- 分布式锁（秒杀场景）
- 计数器（商品销量、访问量）
- 排行榜（热门商品、销量排行）
- 消息队列（配合 BullMQ）

---

## 🔍 搜索引擎

### Elasticsearch 8+

**选择原因：**
1. **强大的全文检索** - 倒排索引，搜索性能优异
2. **分布式架构** - 易于扩展
3. **丰富的查询能力** - 模糊搜索、范围查询、聚合统计
4. **中文分词支持** - IK 分词器等
5. **高可用** - 副本机制

**使用场景：**
- 商品搜索（全文搜索、分类筛选、价格区间）
- 日志分析
- 数据统计

**不选择 PostgreSQL 全文搜索的原因：**
- Elasticsearch 搜索性能更优
- 更复杂的查询支持
- 更好的扩展性

---

## 🔄 ORM/ODM

### TypeORM

**选择原因：**
1. **装饰器语法** - 代码简洁，与 NestJS 风格一致
2. **迁移系统** - 数据库版本管理
3. **关联查询** - 支持一对一、一对多、多对多
4. **查询构建器** - 类型安全，避免 SQL 注入
5. **TypeScript 支持** - 自动生成类型
6. **活跃的社区** - 问题解决快

**不选择 Prisma 的原因：**
- TypeORM 更成熟稳定
- 与 NestJS 集成更好
- 迁移系统更灵活

### Mongoose

**选择原因：**
1. **Schema 定义** - 数据结构清晰
2. **中间件** - pre/post hooks，方便业务逻辑
3. **类型安全** - TypeScript 支持
4. **查询 API** - 简洁易用
5. **官方推荐** - MongoDB 官方 ODM

---

## 🔐 认证与授权

### Passport.js

**选择原因：**
1. **灵活的策略系统** - 支持多种认证方式
2. **中间件集成** - 与 NestJS 完美集成
3. **成熟稳定** - 广泛使用
4. **社区支持** - 大量现成策略

**JWT Strategy：**
- 无状态认证，易于扩展
- 跨域友好
- 移动端支持好

**WeChat Strategy：**
- 微信小程序登录
- 微信开放平台登录

---

## 📨 消息队列

### BullMQ

**选择原因：**
1. **基于 Redis** - 无需额外依赖
2. **支持重试** - 自动重试失败任务
3. **延迟任务** - 支持延迟执行
4. **优先级** - 支持任务优先级
5. **可视化界面** - Bull Board 监控
6. **TypeScript 支持** - 类型安全

**使用场景：**
- 订单超时取消
- 消息通知发送
- 数据统计计算
- 优惠券过期处理

**不选择 RabbitMQ 的原因：**
- 项目规模使用 Redis 足够
- 部署更简单
- 维护成本低

---

## 📄 API 文档

### Swagger / OpenAPI

**选择原因：**
1. **自动生成** - 基于装饰器自动生成文档
2. **在线调试** - Swagger UI 可以直接测试 API
3. **标准化** - OpenAPI 标准
4. **前端对接** - 可以生成前端 SDK
5. **NestJS 原生支持** - @nestjs/swagger 包

---

## 💳 支付集成

### 微信支付 SDK

**选择原因：**
1. **官方 SDK** - 稳定可靠
2. **完整功能** - 统一下单、支付查询、退款等
3. **TypeScript 支持** - 类型安全
4. **小程序支付** - 微信小程序专属支付方式

---

## 🗄️ 文件存储

### 阿里云 OSS / 腾讯云 COS

**选择原因：**
1. **高可用** - 多地域、多可用区
2. **CDN 加速** - 全球加速
3. **成本合理** - 按使用量付费
4. **安全性** - 访问控制、防盗链
5. **上传友好** - 直传、分片上传

**不选择自建文件服务器的原因：**
- 维护成本高
- 扩展性差
- CDN 加速复杂

---

## 🧪 测试框架

### Jest

**选择原因：**
1. **NestJS 默认** - 开箱即用
2. **零配置** - 默认配置合理
3. **快照测试** - UI 组件测试
4. **覆盖率报告** - 内置支持
5. **Mock 功能** - 强大的 mock 系统

---

## 📏 代码规范

### ESLint + Prettier

**选择原因：**
1. **ESLint** - 代码质量检查
2. **Prettier** - 代码格式化
3. **Airbnb 规范** - 业界标准
4. **TypeScript 支持** - 类型检查
5. **Git Hooks** - 提交前自动检查

---

## 🐳 容器化

### Docker

**选择原因：**
1. **环境一致** - 开发、测试、生产环境一致
2. **快速部署** - 一键启动
3. **资源隔离** - 进程隔离
4. **扩展性** - 易于扩展
5. **CI/CD** - 与 DevOps 流程结合

### Docker Compose

**使用原因：**
- 多容器编排
- 本地开发环境
- 快速启动完整服务栈

---

## 📊 监控与日志

### Winston (日志)

**选择原因：**
1. **多传输** - 文件、控制台、HTTP 等
2. **格式化** - 自定义日志格式
3. **日志级别** - DEBUG、INFO、WARN、ERROR
4. **NestJS 集成** - @nestjs/winston

---

## 🚨 性能优化

### 缓存策略

1. **多级缓存**
   - L1：应用内存（可选）
   - L2：Redis

2. **缓存策略**
   - Cache Aside（旁路缓存）
   - 热点数据预加载
   - 缓存穿透防护（布隆过滤器）

3. **缓存失效**
   - 主动失效（数据更新时删除）
   - 被动失效（TTL 过期）

### 数据库优化

1. **索引优化**
   - 主键索引
   - 唯一索引
   - 复合索引

2. **查询优化**
   - 避免 N+1 查询
   - 分页查询
   - 延迟加载

3. **读写分离**
   - 主库写
   - 从库读

---

## 🔒 安全设计

### 认证安全
- JWT Token 认证
- Token 刷新机制
- Token 黑名单（Redis）

### 接口安全
- HTTPS 强制
- 限流（滑动窗口）
- 防重放（签名 + Nonce）
- 参数验证

### 数据安全
- 敏感数据加密
- SQL 注入防护
- XSS 防护

---

## 📈 扩展性设计

### 微服务架构
- 如果业务量增长，可以拆分为微服务
- 模块化设计，易于拆分
- 通信协议：gRPC / HTTP

### 水平扩展
- 无状态服务设计
- 负载均衡
- 数据库读写分离
- Redis 集群

---

## 📝 总结

本项目的技术栈选择遵循以下原则：

1. **成熟稳定** - 选择经过验证的技术
2. **社区活跃** - 便于问题解决
3. **开发效率** - 提高开发效率
4. **性能优先** - 保证系统性能
5. **扩展性强** - 便于未来扩展
6. **成本合理** - 综合考虑开发、运维成本

所有技术栈都是行业内的最佳实践，能够支撑项目从小到大的发展需求。
